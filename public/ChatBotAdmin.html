<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChatBot Admin – RegattaNetworkData | Love Sailing</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <meta property="og:title" content="ChatBot Admin - Love Sailing">
    <meta property="og:description" content="ChatBot administration and RegattaNetworkData management.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://lovesailing.ai/ChatBotAdmin.html">
    <meta property="og:image" content="https://lovesailing.ai/Images/LOVE%20SAILING%20LOGO.JPEG">
    <meta property="og:image:alt" content="Love Sailing Logo">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="ChatBot Admin - Love Sailing">
    <meta name="twitter:description" content="ChatBot administration and RegattaNetworkData management.">
    <meta name="twitter:image" content="https://lovesailing.ai/Images/LOVE%20SAILING%20LOGO.JPEG">
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: #020053;
            color: white;
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        .logo {
            margin-top: 20px;
            max-width: 260px;
            width: 42%;
        }

        .content {
            margin-top: 20px;
            width: 90%;
            max-width: 1000px;
        }

        .content h1 {
            margin: 0 0 6px;
            color: #0088ff;
            font-size: 1.5em;
        }

        .content .sub {
            color: #aaa;
            margin-bottom: 24px;
            font-size: 0.9em;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 16px;
            margin-bottom: 28px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.08);
            padding: 18px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-card .label {
            color: #aaa;
            font-size: 0.85em;
            margin-bottom: 6px;
        }

        .stat-card .value {
            font-size: 1.5em;
            font-weight: bold;
            color: #00dd88;
        }

        .section {
            background: rgba(255, 255, 255, 0.06);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .section h2 {
            margin: 0 0 14px;
            color: #66b3ff;
            font-size: 1.15em;
        }

        .section p {
            margin: 0 0 12px;
            color: #ccc;
            font-size: 0.9em;
        }

        .filters {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 10px;
            margin-bottom: 12px;
        }

        .filters .field {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .filters label {
            font-size: 0.85em;
            color: #aaa;
        }

        .filters input {
            padding: 8px 10px;
            border-radius: 6px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.08);
            color: white;
            font-size: 0.9em;
        }

        .btns {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 12px;
        }

        .btn {
            padding: 10px 16px;
            border-radius: 6px;
            border: none;
            font-size: 0.9em;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #0066cc;
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: #0088ff;
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.15);
            color: white;
        }

        .btn-secondary:hover:not(:disabled) {
            background: rgba(255, 255, 255, 0.25);
        }

        .btn-danger {
            background: #aa3333;
            color: white;
        }

        .btn-danger:hover:not(:disabled) {
            background: #cc4444;
        }

        .upload-wrap {
            margin-top: 10px;
        }

        .upload-wrap input[type="file"] {
            color: #ccc;
        }

        .status {
            margin-top: 10px;
            font-size: 0.9em;
        }

        .status.ok {
            color: #00cc77;
        }

        .status.err {
            color: #ff8888;
        }

        .debug-output {
            margin: 12px 0 0;
            padding: 12px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            font-family: ui-monospace, 'Cascadia Code', 'Consolas', monospace;
            font-size: 0.85em;
            color: #b8e0ff;
            white-space: pre-wrap;
            word-break: break-word;
            max-height: 200px;
            overflow-y: auto;
        }

        .links {
            margin-top: 24px;
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .links a {
            color: #66b3ff;
            text-decoration: none;
        }

        .links a:hover {
            text-decoration: underline;
        }

        .back-link {
            margin-top: 20px;
            color: #888;
            text-decoration: none;
            font-size: 0.9em;
        }

        .back-link:hover {
            color: white;
        }

        .hamburger-menu {
            display: none;
            cursor: pointer;
            position: fixed;
            top: 16px;
            right: 16px;
            z-index: 1000;
            background: rgba(2, 0, 83, 0.9);
            padding: 10px;
            border-radius: 6px;
        }

        .hamburger-menu span {
            display: block;
            width: 24px;
            height: 2px;
            margin: 5px 0;
            background: white;
        }

        .mobile-menu {
            display: none;
            position: fixed;
            inset: 0;
            background: #020053;
            z-index: 999;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 12px;
            text-align: center;
        }

        .mobile-menu a {
            color: white;
            text-decoration: none;
            padding: 14px 24px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            font-size: 1.1em;
        }

        .mobile-menu a:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .close-menu {
            position: absolute;
            top: 16px;
            right: 16px;
            color: white;
            cursor: pointer;
            font-size: 1.4em;
        }

        @media (max-width: 768px) {
            .hamburger-menu {
                display: block;
            }

            .filters {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>
    <img src="/Images/LOVE SAILING LOGO.JPEG" alt="Love Sailing" class="logo">
    <div class="content">
        <h1>ChatBot Admin</h1>
        <p class="sub">Dashboard, exports, backup/restore, and CSV upload for RegattaNetworkData.</p>

        <div class="section">
            <h2>Health &amp; connectivity</h2>
            <p>Test database and OpenAI before using the dashboard or Chatbot.</p>
            <div class="btns">
                <button type="button" class="btn btn-primary" id="healthcheckBtn">Healthcheck (database)</button>
                <button type="button" class="btn btn-secondary" id="testOpenaiBtn">Test OpenAI</button>
            </div>
            <div class="status" id="healthcheckStatus"></div>
        </div>

        <div class="section">
            <h2>Debug</h2>
            <p>Table and row count. Check the browser console (F12 → Console) for full response and any errors.</p>
            <div class="btns">
                <button type="button" class="btn btn-primary" id="debugBtn">Debug</button>
                <button type="button" class="btn btn-secondary" id="refreshBtn">Refresh</button>
            </div>
            <pre class="debug-output" id="debugOutput">—</pre>
        </div>

        <div class="stats" id="stats">
            <div class="stat-card">
                <div class="label">Table</div>
                <div class="value" id="statTable">—</div>
            </div>
            <div class="stat-card">
                <div class="label">Record count</div>
                <div class="value" id="statRecords">—</div>
            </div>
            <div class="stat-card">
                <div class="label">Unique sailors</div>
                <div class="value" id="statSailors">—</div>
            </div>
            <div class="stat-card">
                <div class="label">Unique regattas</div>
                <div class="value" id="statRegattas">—</div>
            </div>
            <div class="stat-card">
                <div class="label">Unique clubs</div>
                <div class="value" id="statClubs">—</div>
            </div>
            <div class="stat-card">
                <div class="label">Date range</div>
                <div class="value" id="statDates">—</div>
            </div>
        </div>
        <p class="status" id="statsHint" style="display:none; margin-top: -12px; margin-bottom: 20px;"></p>

        <div class="section">
            <h2>Download distinct lists</h2>
            <p>CSV files of all unique values. Use to check for duplicates or bad data (e.g. spacing, typos).</p>
            <div class="btns">
                <a href="/api/sailbot/download-sailors" class="btn btn-primary" download>All sailor names</a>
                <a href="/api/sailbot/download-clubs" class="btn btn-primary" download>All club names</a>
                <a href="/api/sailbot/download-regattas" class="btn btn-primary" download>All regattas</a>
            </div>
        </div>

        <div class="section">
            <h2>Cleanup invalid data</h2>
            <p>Set yacht_club to "Unknown" where it doesn't start with a letter (e.g. race results in wrong column).</p>
            <div class="btns">
                <button type="button" class="btn btn-secondary" id="cleanupClubsBtn">Clean invalid club names</button>
            </div>
            <div class="status" id="cleanupClubsStatus"></div>
        </div>

        <div class="section">
            <h2>Export filtered data</h2>
            <p>Apply filters and download CSV for validation.</p>
            <div class="filters" id="exportFilters">
                <div class="field"><label>Skipper</label><input type="text" id="exSkipper" placeholder="Sailor"></div>
                <div class="field"><label>Boat name</label><input type="text" id="exBoat" placeholder="Boat"></div>
                <div class="field"><label>Yacht club</label><input type="text" id="exClub" placeholder="Club"></div>
                <div class="field"><label>Regatta</label><input type="text" id="exRegatta" placeholder="Regatta"></div>
                <div class="field"><label>Year</label><input type="text" id="exYear" placeholder="e.g. 2024"></div>
            </div>
            <div class="btns">
                <button type="button" class="btn btn-primary" id="exportBtn">Export CSV</button>
            </div>
            <div class="status" id="exportStatus"></div>
        </div>

        <div class="section">
            <h2>Backup &amp; restore</h2>
            <p>Backup: download full table as CSV. Restore: upload CSV to replace or append.</p>
            <div class="btns">
                <button type="button" class="btn btn-primary" id="backupBtn">Download backup (CSV)</button>
            </div>
            <div class="status" id="backupStatus"></div>
            <div class="upload-wrap">
                <label><input type="checkbox" id="restoreReplace"> Replace existing data (truncate before
                    restore)</label>
            </div>
            <form id="restoreForm" style="margin-top:10px;">
                <input type="file" id="restoreFile" name="file" accept=".csv,.txt" required>
                <button type="submit" class="btn btn-secondary" id="restoreBtn">Restore from CSV</button>
            </form>
            <div class="status" id="restoreStatus"></div>
        </div>

        <div class="section">
            <h2>Upload CSV (new results)</h2>
            <p>Upload a CSV of regatta results. Columns: regatta_name, regatta_date, category, position, sail_number,
                boat_name, skipper, yacht_club, results, total_points. Missing yacht_club → "Unknown".</p>
            <form id="uploadForm">
                <input type="file" id="uploadFile" name="file" accept=".csv,.txt" required>
                <button type="submit" class="btn btn-primary" id="uploadBtn">Upload CSV</button>
            </form>
            <div class="status" id="uploadStatus"></div>
        </div>

        <div class="links">
            <a href="Chatbot.html">Chatbot</a>
            <a href="https://lovesailing-chatbot.onrender.com/chat">ChatBot (Legacy)</a>
            <a href="Find-regatta.html">Find Regatta</a>
            <a href="index.html">Home</a>
        </div>
    </div>

    <a href="index.html" class="back-link">← Back to Home</a>

    <div class="hamburger-menu" onclick="toggleMenu()"><span></span><span></span><span></span></div>
    <div class="mobile-menu" id="mobileMenu">
        <div class="close-menu" onclick="toggleMenu()">✕</div>
        <a href="index.html">Home</a>
        <a href="SailScan.html">Photo Database</a>
        <a href="Find-regatta.html">Find Regatta</a>
        <a href="Chatbot.html">Chatbot</a>
        <a href="https://lovesailing-chatbot.onrender.com/chat">ChatBot (Legacy)</a>
        <a href="ChatBotAdmin.html">ChatBot Admin</a>
        <a href="Shop.html">Shop</a>
    </div>

    <script>
        function toggleMenu() {
            const m = document.getElementById('mobileMenu');
            m.style.display = m.style.display === 'flex' ? 'none' : 'flex';
        }

        async function loadStats() {
            try {
                const r = await fetch('/api/sailbot/stats');
                const d = await r.json();
                console.log('[SailBot Admin] Stats response:', d);
                if (!d.success) {
                    console.warn('[SailBot Admin] Stats success=false');
                    return;
                }
                document.getElementById('statTable').textContent = d.tableName || '—';
                document.getElementById('statRecords').textContent = (d.total_records ?? '—').toLocaleString();
                document.getElementById('statSailors').textContent = (d.total_sailors ?? '—').toLocaleString();
                document.getElementById('statRegattas').textContent = (d.total_regattas ?? '—').toLocaleString();
                document.getElementById('statClubs').textContent = (d.total_clubs ?? '—').toLocaleString();
                const from = d.earliest_date || '';
                const to = d.latest_date || '';
                document.getElementById('statDates').textContent = (from && to) ? (from + ' … ' + to) : (from || to || '—');
                const hint = document.getElementById('statsHint');
                if (hint) {
                    if (d.total_records === 0) {
                        hint.textContent = '';
                        hint.innerHTML = 'No data yet. Use <strong>Upload CSV</strong> or <strong>Restore</strong> below to add regatta results. The Chatbot searches this data.';
                        hint.style.color = '#f0c050';
                        hint.style.display = 'block';
                    } else {
                        hint.style.display = 'none';
                    }
                }
            } catch (e) {
                console.error('[SailBot Admin] Stats error:', e);
                const hint = document.getElementById('statsHint');
                if (hint) {
                    hint.textContent = 'Could not load stats. Run Healthcheck (database) to verify the connection.';
                    hint.style.color = '#ff8888';
                    hint.style.display = 'block';
                }
            }
        }

        async function runDebug() {
            const out = document.getElementById('debugOutput');
            out.textContent = 'Loading…';
            try {
                const r = await fetch('/api/sailbot/debug');
                const d = await r.json();
                console.log('[SailBot Admin] Debug response:', d);
                if (!r.ok) {
                    console.error('[SailBot Admin] Debug HTTP ' + r.status, d);
                    out.textContent = 'Error ' + r.status + ': ' + (d.error || JSON.stringify(d));
                    return;
                }
                out.textContent = JSON.stringify(d, null, 2);
            } catch (e) {
                console.error('[SailBot Admin] Debug error:', e);
                out.textContent = 'Error: ' + e.message;
            }
        }

        loadStats();
        runDebug();

        const healthcheckStatus = document.getElementById('healthcheckStatus');
        document.getElementById('healthcheckBtn').addEventListener('click', async () => {
            healthcheckStatus.textContent = 'Checking database…';
            healthcheckStatus.className = 'status ok';
            try {
                const r = await fetch('/api/sailbot/healthcheck');
                const d = await r.json();
                console.log('[SailBot Admin] Healthcheck response:', d);
                if (d.success) {
                    healthcheckStatus.textContent = d.message + ' Table ' + (d.tableName || 'regattanetworkdata') + ': ' + (d.regattaNetworkDataTable || '—') + '.';
                    healthcheckStatus.className = 'status ok';
                } else {
                    console.error('[SailBot Admin] Healthcheck failed:', d);
                    healthcheckStatus.textContent = (d.message || d.error) + (d.error ? ' (' + d.error + ')' : '');
                    healthcheckStatus.className = 'status err';
                }
            } catch (e) {
                console.error('[SailBot Admin] Healthcheck error:', e);
                healthcheckStatus.textContent = 'Healthcheck failed: ' + e.message;
                healthcheckStatus.className = 'status err';
            }
        });
        document.getElementById('testOpenaiBtn').addEventListener('click', async () => {
            healthcheckStatus.textContent = 'Testing OpenAI…';
            healthcheckStatus.className = 'status ok';
            try {
                const r = await fetch('/api/sailbot/test-openai');
                const d = await r.json();
                console.log('[SailBot Admin] Test OpenAI response:', d);
                if (d.success) {
                    healthcheckStatus.textContent = (d.message || 'OpenAI OK.') + (d.reply ? ' Reply: "' + d.reply + '"' : '');
                    healthcheckStatus.className = 'status ok';
                } else {
                    console.error('[SailBot Admin] Test OpenAI failed:', d);
                    healthcheckStatus.textContent = (d.message || d.error) + (d.error ? ' (' + d.error + ')' : '');
                    healthcheckStatus.className = 'status err';
                }
            } catch (e) {
                console.error('[SailBot Admin] OpenAI test error:', e);
                healthcheckStatus.textContent = 'OpenAI test failed: ' + e.message;
                healthcheckStatus.className = 'status err';
            }
        });

        document.getElementById('debugBtn').addEventListener('click', async () => {
            await runDebug();
        });
        document.getElementById('refreshBtn').addEventListener('click', async () => {
            await loadStats();
            await runDebug();
        });

        document.getElementById('cleanupClubsBtn').addEventListener('click', async () => {
            const el = document.getElementById('cleanupClubsStatus');
            el.textContent = 'Cleaning up…';
            el.className = 'status ok';
            try {
                const r = await fetch('/api/sailbot/cleanup-clubs', { method: 'POST' });
                const d = await r.json();
                console.log('[SailBot Admin] Cleanup clubs response:', d);
                if (d.success) {
                    el.textContent = d.message || 'Done.';
                    loadStats();
                    runDebug();
                } else {
                    el.textContent = 'Cleanup failed: ' + (d.error || 'Unknown error');
                    el.className = 'status err';
                }
            } catch (e) {
                console.error('[SailBot Admin] Cleanup clubs error:', e);
                el.textContent = 'Cleanup failed: ' + e.message;
                el.className = 'status err';
            }
        });

        document.getElementById('backupBtn').addEventListener('click', async () => {
            const el = document.getElementById('backupStatus');
            el.textContent = 'Preparing backup…';
            el.className = 'status ok';
            try {
                const r = await fetch('/api/sailbot/backup');
                if (!r.ok) throw new Error(r.statusText);
                const blob = await r.blob();
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = 'RegattaNetworkData-backup-' + Date.now() + '.csv';
                a.click();
                URL.revokeObjectURL(a.href);
                el.textContent = 'Backup download started.';
            } catch (e) {
                console.error('[SailBot Admin] Backup error:', e);
                el.textContent = 'Backup failed: ' + e.message;
                el.className = 'status err';
            }
        });

        document.getElementById('exportBtn').addEventListener('click', async () => {
            const params = new URLSearchParams();
            params.set('format', 'csv');
            const s = document.getElementById('exSkipper').value.trim();
            const b = document.getElementById('exBoat').value.trim();
            const c = document.getElementById('exClub').value.trim();
            const g = document.getElementById('exRegatta').value.trim();
            const y = document.getElementById('exYear').value.trim();
            if (s) params.set('skipper', s);
            if (b) params.set('boat_name', b);
            if (c) params.set('yacht_club', c);
            if (g) params.set('regatta_name', g);
            if (y) params.set('year', y);
            const el = document.getElementById('exportStatus');
            el.textContent = 'Preparing download…';
            el.className = 'status ok';
            try {
                const r = await fetch('/api/sailbot/export?' + params.toString());
                if (!r.ok) throw new Error(r.statusText);
                const blob = await r.blob();
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = 'sailbot-export-' + Date.now() + '.csv';
                a.click();
                URL.revokeObjectURL(a.href);
                el.textContent = 'Download started.';
            } catch (e) {
                console.error('[SailBot Admin] Export error:', e);
                el.textContent = 'Export failed: ' + e.message;
                el.className = 'status err';
            }
        });

        const restoreForm = document.getElementById('restoreForm');
        const restoreFile = document.getElementById('restoreFile');
        const restoreBtn = document.getElementById('restoreBtn');
        const restoreStatus = document.getElementById('restoreStatus');
        restoreForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!restoreFile.files.length) return;
            restoreBtn.disabled = true;
            restoreStatus.textContent = 'Restoring…';
            restoreStatus.className = 'status ok';
            const fd = new FormData();
            fd.append('file', restoreFile.files[0]);
            fd.append('replace', document.getElementById('restoreReplace').checked ? 'true' : 'false');
            try {
                const r = await fetch('/api/sailbot/restore', { method: 'POST', body: fd });
                const d = await r.json();
                console.log('[SailBot Admin] Restore response:', d);
                if (d.success) {
                    restoreStatus.textContent = 'Restored ' + (d.inserted || 0) + ' rows.';
                    restoreFile.value = '';
                    loadStats();
                    runDebug();
                } else {
                    console.error('[SailBot Admin] Restore failed:', d);
                    restoreStatus.textContent = 'Restore failed: ' + (d.error || 'Unknown error');
                    restoreStatus.className = 'status err';
                }
            } catch (err) {
                console.error('[SailBot Admin] Restore error:', err);
                restoreStatus.textContent = 'Restore failed: ' + err.message;
                restoreStatus.className = 'status err';
            } finally {
                restoreBtn.disabled = false;
            }
        });

        const uploadForm = document.getElementById('uploadForm');
        const uploadFile = document.getElementById('uploadFile');
        const uploadBtn = document.getElementById('uploadBtn');
        const uploadStatus = document.getElementById('uploadStatus');
        uploadForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!uploadFile.files.length) return;
            uploadBtn.disabled = true;
            uploadStatus.textContent = 'Uploading…';
            uploadStatus.className = 'status ok';
            const fd = new FormData();
            fd.append('file', uploadFile.files[0]);
            try {
                const r = await fetch('/api/sailbot/upload', { method: 'POST', body: fd });
                const d = await r.json();
                console.log('[SailBot Admin] Upload response:', d);
                if (d.success) {
                    uploadStatus.textContent = 'Uploaded ' + (d.inserted || 0) + ' rows.';
                    uploadFile.value = '';
                    loadStats();
                    runDebug();
                } else {
                    console.error('[SailBot Admin] Upload failed:', d);
                    uploadStatus.textContent = 'Upload failed: ' + (d.error || 'Unknown error');
                    uploadStatus.className = 'status err';
                }
            } catch (err) {
                console.error('[SailBot Admin] Upload error:', err);
                uploadStatus.textContent = 'Upload failed: ' + err.message;
                uploadStatus.className = 'status err';
            } finally {
                uploadBtn.disabled = false;
            }
        });
    </script>
</body>

</html>