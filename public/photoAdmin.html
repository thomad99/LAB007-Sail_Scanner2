<!DOCTYPE html>
<html>

<head>
    <title>LAB007 - Photo Administration</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" type="image/x-icon" href="Images/favicon.ico">
    <link rel="shortcut icon" type="image/x-icon" href="Images/favicon.ico">
    <link rel="apple-touch-icon" href="Images/favicon.ico">
    <style>
        /* Reuse the same styles from PhotoUpload.html */
        html,
        body {
            margin: 0;
            padding: 0;
            overflow-x: hidden;
        }

        .header {
            width: 100%;
            margin: 0 0 30px 0;
            padding: 0;
            position: relative;
            background: #f0f0f0;
        }

        .logo {
            width: 100%;
            height: auto;
            display: block;
            object-fit: cover;
        }

        body {
            font-family: Arial, sans-serif;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .admin-section {
            background: #fff;
            border: 3px solid #0066cc;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .admin-section h2 {
            margin: 0 0 10px 0;
            color: #0066cc;
        }

        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .stat-card {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .stat-value {
            font-size: 28px;
            font-weight: bold;
            color: #0066cc;
            margin: 10px 0;
        }

        .stat-label {
            color: #666;
            font-size: 0.9em;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .action-button {
            background: #0066cc;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px;
            min-width: 200px;
        }

        .action-button:hover {
            background: #0052a3;
        }

        .danger-button {
            background: #dc3545;
        }

        .danger-button:hover {
            background: #c82333;
        }

        .success-button {
            background: #28a745;
        }

        .success-button:hover {
            background: #218838;
        }

        .status-message {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
            display: none;
        }

        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .main-container {
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
            padding: 0 20px;
        }

        .footer {
            text-align: center;
            padding: 20px;
            margin-top: 40px;
            background: #ffffff;
            border-top: 1px solid #dee2e6;
        }

        .footer img {
            max-height: 100px;
            width: auto;
            margin: 0 auto;
            display: block;
        }

        @media (max-width: 768px) {
            .stats-container {
                grid-template-columns: 1fr;
            }

            .action-button {
                width: 100%;
                margin: 10px 0;
            }
        }

        /* Add these new styles */
        .validation-results {
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
        }

        .validation-list {
            max-height: 300px;
            overflow-y: auto;
            margin-top: 10px;
        }

        .validation-item {
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .validation-item.error {
            background: #f8d7da;
            color: #721c24;
        }

        .validation-item.success {
            background: #d4edda;
            color: #155724;
        }

        .validation-item.warning {
            background: #fff3cd;
            color: #856404;
        }

        .validation-details {
            font-size: 0.9em;
            color: #666;
        }

        .loading {
            color: #0066cc;
            animation: pulse 1.5s ease-in-out infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        .error {
            color: #dc3545;
        }

        .success {
            color: #28a745;
        }
    </style>
</head>

<body>
    <div class="header">
        <img src="lovesailing-header.jpg" alt="LoveSailing Header" class="logo">
    </div>

    <div class="main-container">
        <div class="admin-section">
            <h2>Photo Administration</h2>

            <div class="stats-container">
                <div class="stat-card">
                    <div class="stat-label">Total Photos in Database</div>
                    <div class="stat-value" id="dbCount">Loading...</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Most Recent Upload</div>
                    <div class="stat-value" id="recentUpload">Loading...</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Total Storage Size</div>
                    <div class="stat-value" id="totalSize">Loading...</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Images in S3 Storage</div>
                    <div class="stat-value" id="s3Count">Loading...</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Images in Uploads Folder</div>
                    <div class="stat-value" id="uploadsCount">Loading...</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Orphaned Database Entries</div>
                    <div class="stat-value" id="orphanedCount">Loading...</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Unique Devices</div>
                    <div class="stat-value" id="deviceCount">Loading...</div>
                </div>
            </div>

            <div id="validationResults" class="validation-results" style="display: none;">
                <h3>Validation Results</h3>
                <div id="validationList" class="validation-list"></div>
            </div>

            <!-- Device Fingerprint Search Section -->
            <div class="admin-section" style="margin-top: 30px;">
                <h2>üîç Device Fingerprint Search</h2>
                <p>Search for all photos uploaded from a specific device</p>

                <div id="deviceFingerprintsList" style="margin: 20px 0; display: none;">
                    <h3>Available Devices</h3>
                    <div id="fingerprintsList" class="validation-list"></div>
                </div>

                <div id="deviceSearchResults" style="margin: 20px 0; display: none;">
                    <h3>Search Results</h3>
                    <div id="devicePhotosList" class="validation-list"></div>
                </div>

                <button class="action-button" onclick="loadDeviceFingerprints()">üì± Load Device Fingerprints</button>
                <button class="action-button" onclick="loadThisDeviceFingerprint()">üîç Load This Device
                    Fingerprint</button>
                <button class="action-button" onclick="clearDeviceSearch()">üóëÔ∏è Clear Search Results</button>
            </div>

            <!-- This Device Fingerprint Section -->
            <div class="admin-section" style="margin-top: 30px;">
                <h2>üì± This Device Fingerprint</h2>
                <p>Manage photos uploaded from this specific device</p>

                <div id="thisDeviceInfo"
                    style="margin: 20px 0; padding: 15px; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 5px;">
                    <h3>Current Device Information</h3>
                    <div id="currentDeviceDetails" style="text-align: left; font-family: monospace; font-size: 0.9em;">
                        <div><strong>Device Type:</strong> <span id="deviceType">Loading...</span></div>
                        <div><strong>Screen Resolution:</strong> <span id="screenResolution">Loading...</span></div>
                        <div><strong>Device Fingerprint:</strong> <span id="deviceFingerprint">Loading...</span></div>
                        <div><strong>User Agent:</strong> <span id="userAgent">Loading...</span></div>
                        <div><strong>Timezone:</strong> <span id="timezone">Loading...</span></div>
                    </div>
                </div>

                <div id="thisDeviceResults" style="margin: 20px 0; display: none;">
                    <h3>Photos from This Device</h3>
                    <div id="thisDevicePhotosList" class="validation-list"></div>
                </div>

                <button class="action-button" onclick="loadThisDevicePhotos()">üì± Load Photos from This Device</button>
                <button class="action-button danger-button" onclick="deleteAllThisDevicePhotos()" id="deleteAllButton"
                    style="display: none;">üóëÔ∏è Delete ALL</button>
                <button class="action-button" onclick="clearThisDeviceSearch()">üóëÔ∏è Clear Results</button>
            </div>

            <div id="statusMessage" class="status-message"></div>

            <div style="margin-top: 30px;">
                <button class="action-button" onclick="testAPI()">üß™ Test API Connection</button>
                <button class="action-button" onclick="debugDatabase()">üîç Debug Database</button>
                <button class="action-button" onclick="validateFiles()">Validate Database Files</button>
                <button class="action-button" onclick="cleanDatabase()">Clean Database Entries</button>
                <button class="action-button" onclick="cleanOrphanedEntries()">Clean Orphaned Entries</button>
                <button class="action-button danger-button" onclick="cleanUploadsFolder()">Clean Uploads Folder</button>
                <button class="action-button success-button" onclick="exportImages()">Export All Images</button>
                <button class="action-button" onclick="loadStats()">üîÑ Refresh Stats</button>
            </div>
        </div>
    </div>

    <div class="footer">
        <a href="https://thomad99.wixstudio.com/lab007" target="_blank">
            <img src="LAB007-FOOTER.JPG" alt="LAB007 Footer">
        </a>
    </div>

    <script>
        async function loadStats() {
            // Set loading state for all stats
            const statElements = ['dbCount', 'recentUpload', 'totalSize', 's3Count', 'uploadsCount', 'orphanedCount'];
            statElements.forEach(id => {
                const element = document.getElementById(id);
                element.textContent = 'Loading...';
                element.className = 'stat-value loading';
            });

            try {
                // Load database count
                try {
                    console.log('Fetching database count...');
                    const dbResponse = await fetch('/api/photo-count');
                    console.log('Database count response status:', dbResponse.status);
                    if (!dbResponse.ok) {
                        throw new Error(`HTTP ${dbResponse.status}: ${dbResponse.statusText}`);
                    }
                    const dbData = await dbResponse.json();
                    console.log('Database count data:', dbData);
                    const element = document.getElementById('dbCount');
                    element.textContent = dbData.total;
                    element.className = 'stat-value success';
                } catch (err) {
                    console.error('Error loading database count:', err);
                    document.getElementById('dbCount').textContent = 'Error';
                    document.getElementById('dbCount').className = 'stat-value error';
                }

                // Load most recent upload date
                try {
                    console.log('Fetching recent upload...');
                    const recentResponse = await fetch('/api/recent-upload');
                    console.log('Recent upload response status:', recentResponse.status);
                    if (!recentResponse.ok) {
                        throw new Error(`HTTP ${recentResponse.status}: ${recentResponse.statusText}`);
                    }
                    const recentData = await recentResponse.json();
                    console.log('Recent upload data:', recentData);
                    const element = document.getElementById('recentUpload');
                    if (recentData.recentUpload) {
                        const date = new Date(recentData.recentUpload);
                        element.textContent = date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
                    } else {
                        element.textContent = 'No uploads';
                    }
                    element.className = 'stat-value success';
                } catch (err) {
                    console.error('Error loading recent upload:', err);
                    document.getElementById('recentUpload').textContent = 'Error';
                    document.getElementById('recentUpload').className = 'stat-value error';
                }

                // Load total storage size
                try {
                    console.log('Fetching storage size...');
                    const sizeResponse = await fetch('/api/storage-size');
                    console.log('Storage size response status:', sizeResponse.status);
                    if (!sizeResponse.ok) {
                        throw new Error(`HTTP ${sizeResponse.status}: ${sizeResponse.statusText}`);
                    }
                    const sizeData = await sizeResponse.json();
                    console.log('Storage size data:', sizeData);
                    const element = document.getElementById('totalSize');
                    element.textContent = formatBytes(sizeData.totalSize);
                    element.className = 'stat-value success';
                } catch (err) {
                    console.error('Error loading storage size:', err);
                    document.getElementById('totalSize').textContent = 'Error';
                    document.getElementById('totalSize').className = 'stat-value error';
                }

                // Load S3 storage count
                try {
                    console.log('Fetching S3 count...');
                    const s3Response = await fetch('/api/s3-count');
                    console.log('S3 count response status:', s3Response.status);
                    if (!s3Response.ok) {
                        throw new Error(`HTTP ${s3Response.status}: ${s3Response.statusText}`);
                    }
                    const s3Data = await s3Response.json();
                    console.log('S3 count data:', s3Data);
                    const element = document.getElementById('s3Count');
                    element.textContent = s3Data.count;
                    element.className = 'stat-value success';
                } catch (err) {
                    console.error('Error loading S3 count:', err);
                    document.getElementById('s3Count').textContent = 'Error';
                    document.getElementById('s3Count').className = 'stat-value error';
                }

                // Load uploads folder count
                try {
                    console.log('Fetching uploads count...');
                    const uploadsResponse = await fetch('/api/folder-count?folder=uploads');
                    console.log('Uploads count response status:', uploadsResponse.status);
                    if (!uploadsResponse.ok) {
                        throw new Error(`HTTP ${uploadsResponse.status}: ${uploadsResponse.statusText}`);
                    }
                    const uploadsData = await uploadsResponse.json();
                    console.log('Uploads count data:', uploadsData);
                    const element = document.getElementById('uploadsCount');
                    element.textContent = uploadsData.count;
                    element.className = 'stat-value success';
                } catch (err) {
                    console.error('Error loading uploads count:', err);
                    document.getElementById('uploadsCount').textContent = 'Error';
                    document.getElementById('uploadsCount').className = 'stat-value error';
                }

                // Load orphaned count
                try {
                    console.log('Fetching orphaned count...');
                    const validationResponse = await fetch('/api/validate-files');
                    console.log('Validation response status:', validationResponse.status);
                    if (!validationResponse.ok) {
                        throw new Error(`HTTP ${validationResponse.status}: ${validationResponse.statusText}`);
                    }
                    const validationData = await validationResponse.json();
                    console.log('Validation data:', validationData);
                    const element = document.getElementById('orphanedCount');
                    element.textContent = validationData.orphanedCount;
                    element.className = 'stat-value success';
                } catch (err) {
                    console.error('Error loading orphaned count:', err);
                    document.getElementById('orphanedCount').textContent = 'Error';
                    document.getElementById('orphanedCount').className = 'stat-value error';
                }

                // Load device count
                try {
                    console.log('Fetching device count...');
                    const deviceResponse = await fetch('/api/device-fingerprints');
                    console.log('Device count response status:', deviceResponse.status);
                    if (!deviceResponse.ok) {
                        throw new Error(`HTTP ${deviceResponse.status}: ${deviceResponse.statusText}`);
                    }
                    const deviceData = await deviceResponse.json();
                    console.log('Device count data:', deviceData);
                    const element = document.getElementById('deviceCount');
                    element.textContent = deviceData.total;
                    element.className = 'stat-value success';
                } catch (err) {
                    console.error('Error loading device count:', err);
                    document.getElementById('deviceCount').textContent = 'Error';
                    document.getElementById('deviceCount').className = 'stat-value error';
                }

            } catch (err) {
                console.error('Error loading stats:', err);
                showStatus('Error loading statistics', 'error');
            }
        }

        async function cleanDatabase() {
            if (!confirm('Are you sure you want to clean the database? This will remove all photo entries.')) {
                return;
            }

            try {
                const response = await fetch('/api/clean-database', {
                    method: 'POST'
                });
                const result = await response.json();
                showStatus(result.message, 'success');
                loadStats(); // Refresh stats
            } catch (err) {
                console.error('Error cleaning database:', err);
                showStatus('Error cleaning database', 'error');
            }
        }

        async function cleanUploadsFolder() {
            if (!confirm('Are you sure you want to clean the uploads folder? This will delete all uploaded images.')) {
                return;
            }

            try {
                const response = await fetch('/api/clean-uploads', {
                    method: 'POST'
                });
                const result = await response.json();
                showStatus(result.message, 'success');
                loadStats(); // Refresh stats
            } catch (err) {
                console.error('Error cleaning uploads folder:', err);
                showStatus('Error cleaning uploads folder', 'error');
            }
        }

        async function exportImages() {
            try {
                const response = await fetch('/api/export-images', {
                    method: 'POST'
                });

                if (!response.ok) {
                    throw new Error('Export failed');
                }

                // Get the blob from the response
                const blob = await response.blob();

                // Create a download link
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'exported_images.zip';
                document.body.appendChild(a);
                a.click();

                // Clean up
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);

                showStatus('Images exported successfully', 'success');
            } catch (err) {
                console.error('Error exporting images:', err);
                showStatus('Error exporting images', 'error');
            }
        }

        async function validateFiles() {
            try {
                const response = await fetch('/api/validate-files');
                const data = await response.json();

                // Update orphaned count
                document.getElementById('orphanedCount').textContent = data.orphanedCount;

                // Show validation results
                const validationResults = document.getElementById('validationResults');
                const validationList = document.getElementById('validationList');

                validationResults.style.display = 'block';
                validationList.innerHTML = data.results.map(item => `
                    <div class="validation-item ${item.status}">
                        <div>
                            <strong>${item.filename}</strong>
                            <div class="validation-details">${item.message}</div>
                        </div>
                        <div>${item.status.toUpperCase()}</div>
                    </div>
                `).join('');

                showStatus(`Validation complete. Found ${data.orphanedCount} orphaned entries.`, 'success');
            } catch (err) {
                console.error('Error validating files:', err);
                showStatus('Error validating files', 'error');
            }
        }

        async function cleanOrphanedEntries() {
            if (!confirm('Are you sure you want to remove all orphaned database entries? This will delete entries for files that no longer exist.')) {
                return;
            }

            try {
                const response = await fetch('/api/clean-orphaned', {
                    method: 'POST'
                });
                const result = await response.json();
                showStatus(result.message, 'success');
                loadStats(); // Refresh stats
                validateFiles(); // Refresh validation results
            } catch (err) {
                console.error('Error cleaning orphaned entries:', err);
                showStatus('Error cleaning orphaned entries', 'error');
            }
        }

        async function testAPI() {
            try {
                console.log('Testing API connection...');
                const response = await fetch('/api/admin-test');
                console.log('Test response status:', response.status);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                console.log('Test API response:', data);

                showStatus(`API Test: ${data.message} | DB: ${data.databaseConnected ? 'Connected' : 'Not Connected'} | S3: ${data.s3Configured ? 'Configured' : 'Not Configured'}`, 'success');
            } catch (err) {
                console.error('API test failed:', err);
                showStatus(`API Test Failed: ${err.message}`, 'error');
            }
        }

        async function debugDatabase() {
            try {
                console.log('Debugging database...');
                const response = await fetch('/api/debug-database');
                console.log('Debug response status:', response.status);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                console.log('Debug data:', data);

                showStatus(`Database Debug: ${data.message}`, 'info'); // Changed to info for debugging
            } catch (err) {
                console.error('Database debug failed:', err);
                showStatus(`Database Debug Failed: ${err.message}`, 'error');
            }
        }

        function showStatus(message, type) {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.textContent = message;
            statusDiv.className = `status-message status-${type}`;
            statusDiv.style.display = 'block';

            // Hide the message after 5 seconds
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 5000);
        }

        function formatBytes(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // Device fingerprint search functions
        async function loadDeviceFingerprints() {
            try {
                console.log('Loading device fingerprints...');
                const response = await fetch('/api/device-fingerprints');
                console.log('Device fingerprints response status:', response.status);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                console.log('Device fingerprints data:', data);

                // Update device count in stats
                const deviceCountElement = document.getElementById('deviceCount');
                deviceCountElement.textContent = data.total;
                deviceCountElement.className = 'stat-value success';

                // Display the fingerprints list
                const fingerprintsList = document.getElementById('fingerprintsList');
                const deviceFingerprintsList = document.getElementById('deviceFingerprintsList');

                if (data.fingerprints.length === 0) {
                    fingerprintsList.innerHTML = '<div class="validation-item warning">No device fingerprints found in database</div>';
                } else {
                    fingerprintsList.innerHTML = data.fingerprints.map(fingerprint => `
                        <div class="validation-item success">
                            <div style="flex: 1;">
                                <div style="font-weight: bold; margin-bottom: 5px;">
                                    üì± ${fingerprint.device_type || 'Unknown Device'} 
                                    <span style="font-size: 0.8em; color: #666;">(${fingerprint.photo_count} photos)</span>
                                </div>
                                <div style="font-size: 0.9em; color: #666; margin-bottom: 5px;">
                                    <strong>Fingerprint:</strong> ${fingerprint.device_fingerprint}
                                </div>
                                <div style="font-size: 0.8em; color: #888;">
                                    <strong>Screen:</strong> ${fingerprint.screen_resolution || 'Unknown'} | 
                                    <strong>Timezone:</strong> ${fingerprint.timezone || 'Unknown'} | 
                                    <strong>First Upload:</strong> ${fingerprint.first_upload ? new Date(fingerprint.first_upload).toLocaleDateString() : 'Unknown'} | 
                                    <strong>Last Upload:</strong> ${fingerprint.last_upload ? new Date(fingerprint.last_upload).toLocaleDateString() : 'Unknown'}
                                </div>
                            </div>
                            <button class="action-button" style="margin: 0; padding: 5px 10px; font-size: 0.8em;" 
                                    onclick="searchPhotosByDevice('${fingerprint.device_fingerprint}')">
                                üîç Find Photos
                            </button>
                        </div>
                    `).join('');
                }

                deviceFingerprintsList.style.display = 'block';
                showStatus(`Loaded ${data.total} unique device fingerprints`, 'success');

            } catch (err) {
                console.error('Error loading device fingerprints:', err);
                showStatus(`Error loading device fingerprints: ${err.message}`, 'error');
            }
        }

        async function searchPhotosByDevice(deviceFingerprint) {
            try {
                console.log('Searching photos for device fingerprint:', deviceFingerprint);
                const response = await fetch(`/api/search-photos?device_fingerprint=${encodeURIComponent(deviceFingerprint)}`);
                console.log('Device search response status:', response.status);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const photos = await response.json();
                console.log('Device search results:', photos);

                // Display the search results
                const devicePhotosList = document.getElementById('devicePhotosList');
                const deviceSearchResults = document.getElementById('deviceSearchResults');

                if (photos.length === 0) {
                    devicePhotosList.innerHTML = '<div class="validation-item warning">No photos found for this device</div>';
                } else {
                    devicePhotosList.innerHTML = photos.map(photo => `
                        <div class="validation-item success">
                            <div style="flex: 1;">
                                <div style="font-weight: bold; margin-bottom: 5px;">
                                    üì∏ ${photo.filename}
                                </div>
                                <div style="font-size: 0.9em; color: #666; margin-bottom: 5px;">
                                    <strong>Sail Number:</strong> ${photo.sail_number || 'N/A'} | 
                                    <strong>Date:</strong> ${photo.date || 'N/A'} | 
                                    <strong>Location:</strong> ${photo.location || 'N/A'}
                                </div>
                                <div style="font-size: 0.8em; color: #888;">
                                    <strong>Uploaded:</strong> ${photo.created_at ? new Date(photo.created_at).toLocaleString() : 'Unknown'} | 
                                    <strong>Device Type:</strong> ${photo.device_type || 'Unknown'}
                                </div>
                            </div>
                            <div style="display: flex; flex-direction: column; gap: 5px;">
                                <button class="action-button" style="margin: 0; padding: 5px 10px; font-size: 0.8em;" 
                                        onclick="window.open('${photo.url}', '_blank')">
                                    üëÅÔ∏è View
                                </button>
                                <button class="action-button danger-button" style="margin: 0; padding: 5px 10px; font-size: 0.8em;" 
                                        onclick="deletePhoto('${photo.id}', '${photo.filename}')">
                                    üóëÔ∏è Delete
                                </button>
                            </div>
                        </div>
                    `).join('');
                }

                deviceSearchResults.style.display = 'block';
                showStatus(`Found ${photos.length} photos for this device`, 'success');

            } catch (err) {
                console.error('Error searching photos by device:', err);
                showStatus(`Error searching photos by device: ${err.message}`, 'error');
            }
        }

        function clearDeviceSearch() {
            document.getElementById('deviceFingerprintsList').style.display = 'none';
            document.getElementById('deviceSearchResults').style.display = 'none';
            showStatus('Device search results cleared', 'success');
        }

        function downloadPhoto(url, filename) {
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        // Function to detect if device is mobile
        function isMobileDevice() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        }

        // Function to generate device fingerprint (same as PhotoUpload.html)
        function generateDeviceFingerprint() {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            ctx.textBaseline = 'top';
            ctx.font = '14px Arial';
            ctx.fillText('Device fingerprint', 2, 2);

            // Create a stable fingerprint without time-dependent elements
            const fingerprint = {
                userAgent: navigator.userAgent,
                language: navigator.language,
                platform: navigator.platform,
                screenResolution: `${screen.width}x${screen.height}`,
                colorDepth: screen.colorDepth,
                timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                canvasHash: canvas.toDataURL(),
                deviceType: isMobileDevice() ? 'Mobile' : 'Desktop',
                // Removed timestamp to make fingerprint stable
                // Added some additional stable identifiers
                hardwareConcurrency: navigator.hardwareConcurrency || 'unknown',
                maxTouchPoints: navigator.maxTouchPoints || 0,
                cookieEnabled: navigator.cookieEnabled,
                doNotTrack: navigator.doNotTrack || 'unknown'
            };

            // Create a hash from the fingerprint data (excluding time-dependent elements)
            const fingerprintString = JSON.stringify(fingerprint);
            let hash = 0;
            for (let i = 0; i < fingerprintString.length; i++) {
                const char = fingerprintString.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash; // Convert to 32-bit integer
            }

            return {
                ...fingerprint,
                // Create a stable fingerprint without timestamp
                fingerprint: Math.abs(hash).toString(36),
                // Add timestamp separately for reference (not used in fingerprint)
                generatedAt: new Date().toISOString()
            };
        }

        // Function to load and search for current device's fingerprint
        async function loadThisDeviceFingerprint() {
            try {
                console.log('Generating current device fingerprint...');
                const deviceFingerprint = generateDeviceFingerprint();
                console.log('Current device fingerprint:', deviceFingerprint.fingerprint);

                // Show device info with fingerprint for debugging
                showStatus(`Current device: ${deviceFingerprint.deviceType} (${deviceFingerprint.screenResolution}) | Fingerprint: ${deviceFingerprint.fingerprint}`, 'info');

                // Search for photos uploaded by this device
                await searchPhotosByDevice(deviceFingerprint.fingerprint);

            } catch (err) {
                console.error('Error loading current device fingerprint:', err);
                showStatus(`Error loading current device fingerprint: ${err.message}`, 'error');
            }
        }

        // Function to populate current device information
        function populateCurrentDeviceInfo() {
            try {
                console.log('Starting to populate current device info...');
                const deviceFingerprint = generateDeviceFingerprint();
                console.log('Generated device fingerprint:', deviceFingerprint);

                // Check if elements exist
                const deviceTypeElement = document.getElementById('deviceType');
                const screenResolutionElement = document.getElementById('screenResolution');
                const deviceFingerprintElement = document.getElementById('deviceFingerprint');
                const userAgentElement = document.getElementById('userAgent');
                const timezoneElement = document.getElementById('timezone');

                if (!deviceTypeElement || !screenResolutionElement || !deviceFingerprintElement || !userAgentElement || !timezoneElement) {
                    console.error('One or more device info elements not found:', {
                        deviceType: !!deviceTypeElement,
                        screenResolution: !!screenResolutionElement,
                        deviceFingerprint: !!deviceFingerprintElement,
                        userAgent: !!userAgentElement,
                        timezone: !!timezoneElement
                    });
                    return;
                }

                // Update the device info display
                deviceTypeElement.textContent = deviceFingerprint.deviceType;
                screenResolutionElement.textContent = deviceFingerprint.screenResolution;
                deviceFingerprintElement.textContent = deviceFingerprint.fingerprint;
                userAgentElement.textContent = deviceFingerprint.userAgent.substring(0, 80) + (deviceFingerprint.userAgent.length > 80 ? '...' : '');
                timezoneElement.textContent = deviceFingerprint.timezone;

                console.log('Current device fingerprint populated successfully:', deviceFingerprint.fingerprint);

                // Store the fingerprint for use in other functions
                window.currentDeviceFingerprint = deviceFingerprint.fingerprint;

            } catch (err) {
                console.error('Error populating device info:', err);
                const deviceTypeElement = document.getElementById('deviceType');
                if (deviceTypeElement) {
                    deviceTypeElement.textContent = 'Error loading device info';
                }
            }
        }

        // Function to load photos from this device (for the new section)
        async function loadThisDevicePhotos() {
            try {
                console.log('Loading photos from this device...');

                // Use the stored fingerprint or generate a new one
                const deviceFingerprint = window.currentDeviceFingerprint || generateDeviceFingerprint().fingerprint;
                console.log('Current device fingerprint:', deviceFingerprint);

                // Show device info
                showStatus(`Loading photos from current device (${deviceFingerprint.substring(0, 20)}...)`, 'info');

                // Search for photos uploaded by this device
                await searchThisDevicePhotos(deviceFingerprint);

            } catch (err) {
                console.error('Error loading this device photos:', err);
                showStatus(`Error loading this device photos: ${err.message}`, 'error');
            }
        }

        // Function to search photos from this device (with view/delete options only)
        async function searchThisDevicePhotos(deviceFingerprint) {
            try {
                console.log('Searching photos for this device fingerprint:', deviceFingerprint);
                const response = await fetch(`/api/search-photos?device_fingerprint=${encodeURIComponent(deviceFingerprint)}`);
                console.log('This device search response status:', response.status);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const photos = await response.json();
                console.log('This device search results:', photos);

                // Display the search results
                const thisDevicePhotosList = document.getElementById('thisDevicePhotosList');
                const thisDeviceResults = document.getElementById('thisDeviceResults');
                const deleteAllButton = document.getElementById('deleteAllButton');

                if (photos.length === 0) {
                    thisDevicePhotosList.innerHTML = '<div class="validation-item warning">No photos found for this device</div>';
                    deleteAllButton.style.display = 'none';
                } else {
                    thisDevicePhotosList.innerHTML = photos.map(photo => `
                        <div class="validation-item success">
                            <div style="flex: 1;">
                                <div style="font-weight: bold; margin-bottom: 5px;">
                                    üì∏ ${photo.filename}
                                </div>
                                <div style="font-size: 0.9em; color: #666; margin-bottom: 5px;">
                                    <strong>Sail Number:</strong> ${photo.sail_number || 'N/A'} | 
                                    <strong>Date:</strong> ${photo.date || 'N/A'} | 
                                    <strong>Location:</strong> ${photo.location || 'N/A'}
                                </div>
                                <div style="font-size: 0.8em; color: #888;">
                                    <strong>Uploaded:</strong> ${photo.created_at ? new Date(photo.created_at).toLocaleString() : 'Unknown'} | 
                                    <strong>Device Type:</strong> ${photo.device_type || 'Unknown'}
                                </div>
                            </div>
                            <div style="display: flex; flex-direction: column; gap: 5px;">
                                <button class="action-button" style="margin: 0; padding: 5px 10px; font-size: 0.8em;" 
                                        onclick="window.open('${photo.url}', '_blank')">
                                    üëÅÔ∏è View
                                </button>
                                <button class="action-button danger-button" style="margin: 0; padding: 5px 10px; font-size: 0.8em;" 
                                        onclick="deletePhoto('${photo.id}', '${photo.filename}')">
                                    üóëÔ∏è Delete
                                </button>
                            </div>
                        </div>
                    `).join('');

                    // Show delete all button with photo count
                    deleteAllButton.style.display = 'inline-block';
                    deleteAllButton.textContent = `üóëÔ∏è Delete ALL (${photos.length} photos)`;
                }

                thisDeviceResults.style.display = 'block';
                showStatus(`Found ${photos.length} photos from this device`, 'success');

            } catch (err) {
                console.error('Error searching this device photos:', err);
                showStatus(`Error searching this device photos: ${err.message}`, 'error');
            }
        }

        // Function to delete a single photo
        async function deletePhoto(photoId, filename) {
            if (!confirm(`Are you sure you want to delete "${filename}"?`)) {
                return;
            }

            try {
                console.log('Deleting photo:', photoId, filename);
                const response = await fetch(`/api/delete-photo/${photoId}`, {
                    method: 'DELETE'
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();
                console.log('Delete result:', result);

                showStatus(`Photo "${filename}" deleted successfully`, 'success');

                // Refresh the this device photos list
                await loadThisDevicePhotos();

                // Refresh stats
                loadStats();

            } catch (err) {
                console.error('Error deleting photo:', err);
                showStatus(`Error deleting photo: ${err.message}`, 'error');
            }
        }

        // Function to delete all photos from this device
        async function deleteAllThisDevicePhotos() {
            try {
                // Use the stored fingerprint or generate a new one
                const deviceFingerprint = window.currentDeviceFingerprint || generateDeviceFingerprint().fingerprint;
                const response = await fetch(`/api/search-photos?device_fingerprint=${encodeURIComponent(deviceFingerprint)}`);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const photos = await response.json();

                if (photos.length === 0) {
                    showStatus('No photos found to delete', 'warning');
                    return;
                }

                const confirmMessage = `Are you sure you want to delete ALL ${photos.length} photos uploaded from this device?\n\nThis action cannot be undone.`;

                if (!confirm(confirmMessage)) {
                    return;
                }

                showStatus(`Deleting ${photos.length} photos...`, 'info');

                // Delete each photo
                let deletedCount = 0;
                for (const photo of photos) {
                    try {
                        const deleteResponse = await fetch(`/api/delete-photo/${photo.id}`, {
                            method: 'DELETE'
                        });

                        if (deleteResponse.ok) {
                            deletedCount++;
                        }
                    } catch (err) {
                        console.error(`Error deleting photo ${photo.filename}:`, err);
                    }
                }

                showStatus(`Successfully deleted ${deletedCount} out of ${photos.length} photos`, 'success');

                // Clear the results and refresh stats
                clearThisDeviceSearch();
                loadStats();

            } catch (err) {
                console.error('Error deleting all photos:', err);
                showStatus(`Error deleting all photos: ${err.message}`, 'error');
            }
        }

        // Function to clear this device search results
        function clearThisDeviceSearch() {
            document.getElementById('thisDeviceResults').style.display = 'none';
            document.getElementById('deleteAllButton').style.display = 'none';
            showStatus('This device search results cleared', 'success');
        }

        // Load stats and populate device info when page loads
        document.addEventListener('DOMContentLoaded', function () {
            console.log('DOMContentLoaded event fired - starting page initialization...');
            loadStats();
            console.log('loadStats() called, now calling populateCurrentDeviceInfo()...');
            populateCurrentDeviceInfo();
            console.log('Page initialization complete');
        });
    </script>
</body>

</html>