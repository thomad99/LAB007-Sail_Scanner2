<!DOCTYPE html>
<html>

<head>
    <title>LoveSailing Sailing Photo Search Engine - Regatta sailing Photos</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description"
        content="Search, view, and purchase high-quality regatta sailing photos. Find images of sailboats, yacht clubs, sailing events, championships, dinghies, offshore races, and more. The ultimate sailing photo search engine for sailors, photographers, and regatta fans.">
    <meta name="keywords"
        content="sailing photos, regatta images, yacht club photos, sailboat pictures, sailing event photography, championship sailing, dinghy photos, offshore racing, sailing gallery, sailing search engine, buy sailing photos, sailing stock images, LoveSailing, sailing regatta, sailing competition, sailing team, sailing action shots, sailing sports, sailing event images, sailing fleet, sailing race, sailing event pictures, sailing event gallery, sailing event search, sailing event download, sailing event purchase, sailing event prints, sailing event digital, sailing event archive, sailing event collection, sailing event catalog, sailing event database, sailing event marketplace, sailing event store, sailing event shop, sailing event buy, sailing event sell, sailing event license, sailing event stock, sailing event portfolio, sailing event showcase, sailing event exhibition, sailing event display, sailing event view, sailing event preview, sailing event browse, sailing event explore, sailing event discover, sailing event find, sailing event locate, sailing event search engine, regatta, yacht, sailboat, sailing, photos, images, pictures, gallery, event, competition, team, fleet, race, championship, dinghy, offshore, action, sports, club, club photos, club images, club gallery, club event, club regatta, club sailing, club race, club championship, club dinghy, club offshore, club action, club sports, club team, club fleet, club competition, club event, club gallery, club search, club find, club locate, club discover, club explore, club preview, club view, club browse, club buy, club purchase, club download, club prints, club digital, club archive, club collection, club catalog, club database, club marketplace, club store, club shop, club sell, club license, club stock, club portfolio, club showcase, club exhibition, club display, club event, club preview, club browse, club explore, club discover, club find, club locate, club search engine">
    <meta name="robots" content="index, follow">
    <meta property="og:title" content="LoveSailing Sailing Photo Search Engine - Regatta sailing Photos">
    <meta property="og:description"
        content="Search, view, and purchase high-quality regatta sailing photos. Find images of sailboats, yacht clubs, sailing events, championships, dinghies, offshore races, and more.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://lovesailing.ai/">
    <meta property="og:image" content="https://lovesailing.ai/lovesailing-header.jpg">
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico">
    <link rel="apple-touch-icon" href="/favicon.ico">
    <style>
        /* Mobile app styling - same as PhotoUpload.html */
        html,
        body {
            margin: 0;
            padding: 0;
            height: 100vh;
            overflow: hidden;
            position: fixed;
            width: 100%;
            background-color: #020053;
            font-family: Arial, sans-serif;
        }

        .main-container {
            height: 100vh;
            display: flex;
            flex-direction: column;
            background: transparent;
        }

        .content-wrapper {
            flex: 1;
            overflow: hidden;
            background: transparent;
        }

        /* Mobile tabs */
        .mobile-tabs {
            display: flex;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            margin: 10px;
            padding: 5px;
        }

        .mobile-tab {
            flex: 1;
            background: transparent;
            border: none;
            color: white;
            padding: 12px;
            font-size: 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .mobile-tab.active {
            background: rgba(255, 255, 255, 0.2);
            font-weight: bold;
        }

        .mobile-tab-content {
            display: none;
            height: calc(100vh - 80px);
            overflow-y: auto;
            padding: 10px;
            padding-bottom: 60px;
            background: transparent;
        }

        .mobile-tab-content.active {
            display: block;
        }

        /* Search section styling */
        .search-section {
            background: rgba(255, 255, 255, 0.95);
            border: 3px solid #0066cc;
            border-radius: 15px;
            padding: 20px;
            padding-bottom: 40px;
            margin: 10px 0;
            text-align: left;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .search-section h2 {
            margin: 0 0 15px 0;
            color: #0066cc;
            text-align: center;
            font-size: 22px;
        }

        .search-form-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .search-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            box-sizing: border-box;
            background: white;
        }

        .search-input:focus {
            border-color: #0066cc;
            outline: none;
            box-shadow: 0 0 5px rgba(0, 102, 204, 0.3);
        }

        .search-label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
            font-size: 16px;
        }

        .search-row {
            margin-bottom: 10px;
            width: 100%;
        }

        .search-buttons {
            margin-top: 20px;
            margin-bottom: 40px;
            text-align: center;
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .search-button,
        .clear-button {
            flex: 1;
            max-width: 150px;
            padding: 20px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            border: none;
            min-height: 60px;
            transition: all 0.3s;
        }

        .search-button {
            background: #0066cc;
            color: white;
        }

        .search-button:hover {
            background: #0052a3;
            transform: translateY(-2px);
        }

        .search-button:active {
            background: #004080;
            transform: translateY(0);
        }

        .clear-button {
            background: #6c757d;
            color: white;
        }

        .clear-button:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }

        /* Results section */
        .results-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 15px;
            margin: 10px 0;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .photo-count {
            text-align: center;
            color: #666;
            font-size: 16px;
            margin-bottom: 15px;
            padding: 10px;
            background: rgba(0, 102, 204, 0.1);
            border-radius: 8px;
        }

        .photo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            padding: 10px 0;
        }

        .photo-card {
            border: 2px solid #ddd;
            border-radius: 12px;
            overflow: hidden;
            background: white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            transition: all 0.3s;
        }

        .photo-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
            border-color: #0066cc;
        }

        .photo-card img {
            width: 100%;
            height: 120px;
            object-fit: cover;
            display: block;
        }

        .photo-info {
            padding: 10px;
            font-size: 14px;
            color: #333;
        }

        .photo-info p {
            margin: 4px 0;
            font-size: 14px;
            line-height: 1.3;
        }

        .photo-info strong {
            color: #0066cc;
            font-size: 14px;
        }

        .view-button {
            display: block;
            width: 100%;
            background: #0066cc;
            color: white;
            padding: 10px;
            border-radius: 8px;
            text-decoration: none;
            text-align: center;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            margin-top: 8px;
            transition: background 0.3s;
        }

        .view-button:hover {
            background: #0052a3;
        }

        /* Modal styling */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.9);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            display: flex;
            flex-direction: column;
            background: white;
            max-width: 95vw;
            max-height: 90vh;
            border-radius: 15px;
            overflow: hidden;
            position: relative;
        }

        .modal-image-container {
            position: relative;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 300px;
        }

        .modal-image {
            max-width: 100%;
            max-height: 60vh;
            display: block;
            border-radius: 15px 15px 0 0;
        }

        .close-button {
            position: absolute;
            top: 15px;
            right: 15px;
            color: #fff;
            font-size: 32px;
            cursor: pointer;
            z-index: 10;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
        }

        .nav-button {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            color: #333;
            font-size: 24px;
            cursor: pointer;
            z-index: 10;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid rgba(0, 102, 204, 0.3);
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .nav-button:hover {
            background: rgba(0, 102, 204, 0.1);
            border-color: rgba(0, 102, 204, 0.6);
            transform: translateY(-50%) scale(1.05);
        }

        .nav-button.prev {
            left: 15px;
        }

        .nav-button.next {
            right: 15px;
        }

        .nav-button:disabled {
            opacity: 0.3;
            cursor: not-allowed;
            background: rgba(255, 255, 255, 0.5);
        }

        .nav-button:disabled:hover {
            background: rgba(255, 255, 255, 0.5);
            transform: translateY(-50%) scale(1);
            border-color: rgba(0, 102, 204, 0.3);
        }

        /* Action button image styling */
        .action-button-image {
            cursor: pointer;
            transition: all 0.3s ease;
            border-radius: 8px;
        }

        .action-button-image:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .action-button-image:active {
            transform: scale(0.98);
        }

        .modal-metadata {
            padding: 20px;
            background: #f8f9fa;
            max-height: 30vh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .modal-metadata h3 {
            margin: 0 0 15px 0;
            color: #0066cc;
            font-size: 18px;
        }

        .metadata-item {
            padding: 10px;
            background: white;
            border-radius: 8px;
            border-left: 4px solid #0066cc;
            margin-bottom: 8px;
        }

        .metadata-item strong {
            color: #0066cc;
            font-weight: 600;
            font-size: 14px;
        }

        .metadata-item .value {
            color: #333;
            margin-left: 5px;
            font-size: 14px;
        }



        /* No results styling */
        .no-results {
            text-align: center;
            padding: 40px 20px;
            color: #666;
            font-size: 18px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            margin: 20px 0;
        }

        /* Loading styling */
        .loading {
            text-align: center;
            padding: 40px 20px;
            color: #0066cc;
            font-size: 18px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            margin: 20px 0;
        }

        /* Desktop styles */
        @media (min-width: 769px) {
            .mobile-tabs {
                display: none;
            }

            .mobile-tab-content {
                display: block;
                height: 100vh;
                overflow-y: auto;
            }

            /* Desktop container constraints */
            .search-section {
                max-width: 800px;
                margin: 20px auto;
            }

            .search-form-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 20px;
            }

            /* Desktop input field sizing */
            .search-input {
                width: 20ch;
                max-width: 100%;
                min-width: 200px;
            }

            /* Desktop button sizing */
            .search-button,
            .clear-button {
                padding: 20px 25px;
                min-height: 60px;
                max-width: 120px;
            }

            .photo-grid {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 20px;
            }

            .modal-content {
                flex-direction: row;
                max-width: 90vw;
            }

            .modal-image-container {
                min-width: 400px;
                border-radius: 15px 0 0 15px;
            }

            .modal-image {
                border-radius: 15px 0 0 15px;
            }

            .modal-metadata {
                min-width: 300px;
                max-height: none;
            }
        }

        /* Mobile modal improvements */
        @media (max-width: 768px) {
            .modal-content {
                max-width: 95vw;
                max-height: 95vh;
                margin: 10px;
            }

            .modal-image-container {
                min-height: 200px;
                max-height: 50vh;
            }

            .modal-image {
                max-height: 45vh;
            }

            .modal-metadata {
                max-height: 40vh;
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
                padding: 12px;
            }

            .metadata-item {
                padding: 8px;
                margin-bottom: 6px;
                font-size: 14px;
            }

            .metadata-item strong {
                font-size: 13px;
            }

            .metadata-item .value {
                font-size: 13px;
            }

            /* Mobile-specific styling for basic metadata */
            #basicMetadata {
                padding: 10px !important;
                margin-top: 10px !important;
            }

            #basicMetadataContent>div {
                margin-bottom: 6px !important;
                font-size: 13px !important;
                line-height: 1.4;
                word-wrap: break-word;
                overflow-wrap: break-word;
            }

            #basicMetadataContent strong {
                font-size: 12px !important;
                display: block;
                margin-bottom: 2px;
            }

            #basicMetadataContent span {
                font-size: 13px !important;
                margin-left: 0 !important;
                display: block;
            }

            /* Ensure buttons are side-by-side on mobile */
            #modalActions {
                flex-direction: row !important;
                flex-wrap: nowrap !important;
            }

            #modalActions button {
                flex: 1 !important;
                min-width: unset !important;
                margin: 0 5px;
            }

            /* Mobile action button sizing */
            .action-button-image {
                max-width: 180px;
                height: 50px;
            }
        }

        /* Desktop action button sizing */
        @media (min-width: 769px) {
            .action-button-image {
                max-width: 220px;
                height: 60px;
            }
        }

        /* Large desktop action button sizing */
        @media (min-width: 1200px) {
            .action-button-image {
                max-width: 250px;
                height: 70px;
            }
        }

        /* Touch-friendly improvements */
        .search-input,
        .search-button,
        .clear-button,
        .view-button {
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        .mobile-tab-content {
            -webkit-overflow-scrolling: touch;
        }

        /* Large desktop screens */
        @media (min-width: 1200px) {
            .search-section {
                max-width: 900px;
            }

            .search-input {
                width: 22ch;
                min-width: 220px;
            }
        }

        /* Extra large desktop screens */
        @media (min-width: 1600px) {
            .search-section {
                max-width: 1000px;
            }

            .search-input {
                width: 25ch;
                min-width: 250px;
            }
        }
    </style>
    <script src="https://js.stripe.com/v3/"></script>
</head>

<body>
    <div class="main-container">
        <div class="content-wrapper">
            <!-- Mobile tabs -->
            <div class="mobile-tabs">
                <button class="mobile-tab active" onclick="switchTab('search', event)">Search</button>
                <button class="mobile-tab" onclick="switchTab('results', event)">Results</button>
            </div>

            <!-- Search tab -->
            <div id="searchTab" class="mobile-tab-content active">
                <div class="search-section">
                    <h2>Search Photos</h2>
                    <div id="photoCount" class="photo-count">
                        Loading photo count...
                    </div>
                    <div class="search-form-grid">
                        <div class="search-row">
                            <label for="sailNumber" class="search-label">Sail Number</label>
                            <input type="text" id="sailNumber" class="search-input" autocomplete="off">
                        </div>
                        <div class="search-row">
                            <label for="date" class="search-label">Date</label>
                            <input type="date" id="date" class="search-input" autocomplete="off">
                        </div>
                        <div class="search-row">
                            <label for="regattaName" class="search-label">Regatta Name</label>
                            <input type="text" id="regattaName" class="search-input" autocomplete="off" list="regattaNameList">
                            <datalist id="regattaNameList"></datalist>
                        </div>
                        <div class="search-row">
                            <label for="yachtClub" class="search-label">Yacht Club</label>
                            <input type="text" id="yachtClub" class="search-input" list="yachtClubList"
                                autocomplete="off">
                            <datalist id="yachtClubList">
                                <option value="Alamitos Bay Yacht Club">
                                <option value="American Yacht Club">
                                <option value="Annapolis Yacht Club">
                                <option value="Atlanta Yacht Club">
                                <option value="Austin Yacht Club">
                                <option value="Avalon Yacht Club">
                                <option value="Bay Head Yacht Club">
                                <option value="Beverly Yacht Club">
                                <option value="Chicago Yacht Club">
                                <option value="Corinthian Yacht Club">
                                <option value="Eastern Yacht Club">
                                <option value="Fort Worth Yacht Club">
                                <option value="Houston Yacht Club">
                                <option value="Lake Norman Yacht Club">
                                <option value="Larchmont Yacht Club">
                                <option value="Long Beach Yacht Club">
                                <option value="New York Yacht Club">
                                <option value="Newport Harbor Yacht Club">
                                <option value="San Diego Yacht Club">
                                <option value="San Francisco Yacht Club">
                                <option value="Seattle Yacht Club">
                                <option value="St. Francis Yacht Club">
                            </datalist>
                        </div>
                        <div class="search-row">
                            <label for="photographerName" class="search-label">Photographer</label>
                            <input type="text" id="photographerName" class="search-input" autocomplete="off">
                        </div>
                        <div class="search-row">
                            <label for="location" class="search-label">Location</label>
                            <input type="text" id="location" class="search-input" autocomplete="off" list="locationList">
                            <datalist id="locationList"></datalist>
                        </div>
                        <div class="search-buttons">
                            <button class="search-button" id="searchBtn"
                                onclick="console.log('Search button onclick triggered'); searchPhotos();">Search</button>
                            <button class="clear-button" onclick="clearSearch()">Clear</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Results tab -->
            <div id="resultsTab" class="mobile-tab-content">
                <div class="results-section">
                    <div id="results"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div id="imageModal" class="modal" tabindex="-1" aria-modal="true" role="dialog">
        <div class="close-button" onclick="closeModal()">&times;</div>
        <button class="nav-button prev" id="prevButton" onclick="showPreviousPhoto()" disabled>&#8249;</button>
        <button class="nav-button next" id="nextButton" onclick="showNextPhoto()" disabled>&#8250;</button>
        <div class="modal-content" id="modalContent">
            <div class="modal-image-container" id="modalImageContainer">
                <img id="modalImage" class="modal-image" src="" alt="Preview">
            </div>
            <div class="modal-metadata" id="modalMetadata">
                <div id="modalActions"
                    style="margin: 0 0 12px 0; display: flex; gap: 10px; flex-wrap: wrap; justify-content: center;">
                    <img id="downloadBtn" src="Images/Download_button.jpg" alt="Download" class="action-button-image"
                        onclick="downloadCurrentPhoto()"
                        style="cursor: pointer; flex: 1; min-width: 140px; max-width: 250px; height: auto; object-fit: contain; transition: transform 0.2s ease;">
                    <img id="shareBtn" src="Images/share_button.jpg" alt="Share" class="action-button-image"
                        onclick="sharePhotoLink()"
                        style="cursor: pointer; flex: 1; min-width: 140px; max-width: 250px; height: auto; object-fit: contain; transition: transform 0.2s ease;">
                </div>
                <div id="basicMetadata"
                    style="margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                    <div id="basicMetadataContent">
                        <!-- Basic metadata will be populated here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // API configuration - using relative URLs since mobile was working
        console.log('Using relative API URLs');

        // Tab switching function
        function switchTab(tabName, event) {
            // Hide all tab contents
            const tabContents = document.querySelectorAll('.mobile-tab-content');
            tabContents.forEach(content => {
                content.classList.remove('active');
            });

            // Remove active class from all tabs
            const tabs = document.querySelectorAll('.mobile-tab');
            tabs.forEach(tab => {
                tab.classList.remove('active');
            });

            // Show selected tab content
            document.getElementById(tabName + 'Tab').classList.add('active');

            // Add active class to clicked tab if event is provided
            if (event && event.target) {
                event.target.classList.add('active');
            }
        }

        // Call this when the page loads
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('Page loaded, checking server connectivity...');
            console.log('Window width:', window.innerWidth);
            console.log('User agent:', navigator.userAgent);

            // Test server connectivity first
            try {
                const testResponse = await fetch('/api/photo-count');
                if (testResponse.ok) {
                    console.log('Server is responding');
                    loadPhotoCount();
                } else {
                    console.error('Server responded with error:', testResponse.status);
                    document.getElementById('photoCount').innerHTML = 'Server error. Please try again.';
                }
            } catch (err) {
                console.error('Server connectivity test failed:', err);
                document.getElementById('photoCount').innerHTML = 'Cannot connect to server. Please check if the server is running.';
            }

            // Add additional event listener for search button
            const searchBtn = document.getElementById('searchBtn');
            if (searchBtn) {
                console.log('Search button found, adding event listener');
                console.log('Search button element:', searchBtn);
                console.log('Search button onclick:', searchBtn.onclick);

                searchBtn.addEventListener('click', (e) => {
                    console.log('Search button clicked via event listener');
                    searchPhotos();
                });

                // Test if the button is clickable
                searchBtn.addEventListener('mousedown', (e) => {
                    console.log('Search button mousedown event');
                });

                searchBtn.addEventListener('mouseup', (e) => {
                    console.log('Search button mouseup event');
                });
            } else {
                console.error('Search button not found!');
            }

            // Load helper dropdowns
            loadPhotoFilters();
        });

        async function loadPhotoCount() {
            try {
                console.log('Loading photo count...');
                const response = await fetch('/api/photo-count');
                console.log('Photo count response status:', response.status);
                const data = await response.json();
                console.log('Photo count data:', data);
                const countDiv = document.getElementById('photoCount');
                countDiv.innerHTML = `Total photo count: ${data.total}`;
            } catch (err) {
                console.error('Error loading photo count:', err);
                document.getElementById('photoCount').innerHTML = 'Error loading photo count';
            }
        }

        async function loadPhotoFilters() {
            try {
                const regattaResp = await fetch('/api/photo-regattas');
                const regattaData = await regattaResp.json();
                if (regattaData && regattaData.regattas) {
                    const dl = document.getElementById('regattaNameList');
                    if (dl) {
                        dl.innerHTML = '';
                        regattaData.regattas.forEach(name => {
                            const opt = document.createElement('option');
                            opt.value = name;
                            dl.appendChild(opt);
                        });
                    }
                }
            } catch (err) {
                console.error('Error loading regatta list:', err);
            }

            try {
                const locResp = await fetch('/api/photo-locations');
                const locData = await locResp.json();
                if (locData && locData.locations) {
                    const dl = document.getElementById('locationList');
                    if (dl) {
                        dl.innerHTML = '';
                        locData.locations.forEach(loc => {
                            const opt = document.createElement('option');
                            opt.value = loc;
                            dl.appendChild(opt);
                        });
                    }
                }
            } catch (err) {
                console.error('Error loading location list:', err);
            }
        }

        async function searchPhotos() {
            console.log('=== SEARCH FUNCTION STARTED ===');
            console.log('Search function called');
            console.log('Window width:', window.innerWidth);
            console.log('Is mobile:', window.innerWidth <= 768);

            try {
                const resultsDiv = document.getElementById('results');
                if (!resultsDiv) {
                    console.error('Results div not found!');
                    return;
                }
                console.log('Results div found:', resultsDiv);
                resultsDiv.innerHTML = '<div class="loading">Searching...</div>';

                // Switch to results tab on mobile
                if (window.innerWidth <= 768) {
                    setTimeout(() => {
                        switchTab('results');
                    }, 300);
                }

                const params = new URLSearchParams({
                    sail_number: document.getElementById('sailNumber').value,
                    date: document.getElementById('date').value,
                    regatta_name: document.getElementById('regattaName').value,
                    yacht_club: document.getElementById('yachtClub').value,
                    photographer_name: document.getElementById('photographerName').value,
                    location: document.getElementById('location').value
                });

                try {
                    console.log('Fetching from:', `/api/search-photos?${params}`);
                    const response = await fetch(`/api/search-photos?${params}`);
                    console.log('Response status:', response.status);
                    const photos = await response.json();
                    console.log('Photos received:', photos.length);

                    if (photos.length === 0) {
                        resultsDiv.innerHTML = '<div class="no-results">No photos found matching your criteria.</div>';
                        return;
                    }

                    displaySearchResults(photos);

                    // On desktop, scroll to results to make them visible
                    if (window.innerWidth > 768) {
                        setTimeout(() => {
                            resultsDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        }, 100);

                        // Show a brief success message on desktop
                        const successMsg = document.createElement('div');
                        successMsg.style.cssText = `
                            position: fixed;
                            top: 20px;
                            right: 20px;
                            background: #28a745;
                            color: white;
                            padding: 15px 20px;
                            border-radius: 8px;
                            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                            z-index: 1000;
                            font-weight: bold;
                        `;
                        successMsg.textContent = `Found ${photos.length} photo${photos.length !== 1 ? 's' : ''}!`;
                        document.body.appendChild(successMsg);

                        setTimeout(() => {
                            successMsg.remove();
                        }, 3000);
                    }
                } catch (err) {
                    console.error('Error searching photos:', err);
                    resultsDiv.innerHTML = '<div class="no-results" style="color: red;">Error searching photos. Please try again.</div>';
                }
            } catch (err) {
                console.error('Error in searchPhotos function:', err);
            }
        }

        function displaySearchResults(photos) {
            const resultsContainer = document.getElementById('results');
            resultsContainer.innerHTML = '';

            if (photos.length === 0) {
                resultsContainer.innerHTML = '<div class="no-results">No photos found matching your search criteria.</div>';
                return;
            }

            // Deduplicate photos based on filename
            const uniquePhotos = photos.reduce((acc, current) => {
                const x = acc.find(item => item.filename === current.filename);
                if (!x) {
                    return acc.concat([current]);
                } else {
                    return acc;
                }
            }, []);

            const matchCount = document.createElement('div');
            matchCount.className = 'photo-count';
            matchCount.innerHTML = `Found ${uniquePhotos.length} unique photo${uniquePhotos.length !== 1 ? 's' : ''}`;
            resultsContainer.appendChild(matchCount);

            // Add Back to Search button on desktop
            if (window.innerWidth > 768) {
                const backToSearchButton = document.createElement('button');
                backToSearchButton.className = 'search-button';
                backToSearchButton.style.cssText = `
                    margin: 0 auto 20px auto;
                    display: block;
                    max-width: 300px;
                    padding: 15px 30px;
                    font-size: 16px;
                `;
                backToSearchButton.innerHTML = 'â† Back to Search';
                backToSearchButton.onclick = () => {
                    // Scroll back to search form
                    document.getElementById('searchTab').scrollIntoView({ behavior: 'smooth', block: 'start' });
                };
                resultsContainer.appendChild(backToSearchButton);
            }

            const grid = document.createElement('div');
            grid.className = 'photo-grid';

            uniquePhotos.forEach((photo, index) => {
                const card = document.createElement('div');
                card.className = 'photo-card';
                card.onclick = () => openModal(photo, index, uniquePhotos);

                const img = document.createElement('img');
                img.src = photo.url;
                img.alt = `Sail ${photo.sail_number}`;
                img.loading = 'lazy';
                img.onerror = () => {
                    img.src = 'https://via.placeholder.com/300x200?text=Image+Not+Available';
                    img.alt = 'Image not available';
                };

                const info = document.createElement('div');
                info.className = 'photo-info';
                info.innerHTML = `
                    <p><strong>Sail:</strong> ${photo.sail_number}</p>
                    <p><strong>Date:</strong> ${new Date(photo.date).toLocaleDateString()}</p>
                    <p><strong>Regatta:</strong> ${photo.regatta_name || 'Not specified'}</p>
                `;

                const viewButton = document.createElement('button');
                viewButton.className = 'view-button';
                viewButton.innerHTML = 'View Photo';
                viewButton.onclick = (e) => {
                    e.stopPropagation();
                    openModal(photo, index, uniquePhotos);
                };

                card.appendChild(img);
                card.appendChild(info);
                card.appendChild(viewButton);
                grid.appendChild(card);
            });

            resultsContainer.appendChild(grid);
        }

        // Modal logic
        let currentModalPhoto = null;
        let currentPhotoIndex = -1;
        let currentPhotosArray = [];
        async function openModal(photo, photoIndex = -1, photosArray = []) {
            currentModalPhoto = photo;
            currentPhotoIndex = photoIndex;
            currentPhotosArray = photosArray;

            const modal = document.getElementById('imageModal');
            const modalImg = document.getElementById('modalImage');
            const modalMetadata = document.getElementById('modalMetadata');
            const basicMetadataContent = document.getElementById('basicMetadataContent');
            const metadataContent = document.getElementById('metadataContent');
            const metadataToggle = document.getElementById('metadataToggle');
            const prevButton = document.getElementById('prevButton');
            const nextButton = document.getElementById('nextButton');

            modalImg.src = photo.url;
            modalImg.alt = `Sail number ${photo.sail_number}`;

            // Update navigation buttons
            if (currentPhotosArray.length > 0) {
                prevButton.disabled = currentPhotoIndex <= 0;
                nextButton.disabled = currentPhotoIndex >= currentPhotosArray.length - 1;
            } else {
                prevButton.disabled = true;
                nextButton.disabled = true;
            }

            // Clear previous metadata
            basicMetadataContent.innerHTML = '';

            // Populate basic metadata (always visible)
            const basicFields = [
                { key: 'regatta_name', label: 'Regatta Name' },
                { key: 'sail_number', label: 'Sail Number' },
                { key: 'location', label: 'Location' },
                { key: 'photographer_name', label: 'Photographer' },
                {
                    key: 'photographer_website', label: 'Photographer Website', formatter: (value) => {
                        if (value && value !== 'null' && value !== 'undefined' && value !== '') {
                            // Check if the URL already has http:// or https://
                            const url = value.startsWith('http://') || value.startsWith('https://') ? value : `https://${value}`;
                            return `<a href="${url}" target="_blank" style="color: #0066cc; text-decoration: underline;">${value}</a>`;
                        }
                        return value;
                    }
                }
            ];

            basicFields.forEach(field => {
                const value = photo[field.key];
                const formattedValue = field.formatter ? field.formatter(value) : value;

                if (formattedValue && formattedValue !== 'null' && formattedValue !== 'undefined' && formattedValue !== '') {
                    const basicItem = document.createElement('div');
                    const isMobile = window.innerWidth <= 768;
                    basicItem.style.cssText = isMobile ? 'margin-bottom: 6px; font-size: 13px; line-height: 1.4;' : 'margin-bottom: 8px; font-size: 16px;';
                    basicItem.innerHTML = `
                        <strong style="color: #0066cc; font-weight: 600; ${isMobile ? 'display: block; margin-bottom: 2px; font-size: 12px;' : ''}">${field.label}:</strong>
                        <span style="color: #333; ${isMobile ? 'display: block; margin-left: 0; font-size: 13px;' : 'margin-left: 8px;'}">${formattedValue}</span>
                    `;
                    basicMetadataContent.appendChild(basicItem);
                }
            });

            modal.style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('imageModal').style.display = 'none';
            currentModalPhoto = null;
        }

        function clearSearch() {
            // Clear all input fields
            document.getElementById('sailNumber').value = '';
            document.getElementById('date').value = '';
            document.getElementById('regattaName').value = '';
            document.getElementById('yachtClub').value = '';
            document.getElementById('photographerName').value = '';
            document.getElementById('location').value = '';

            // Clear the results
            document.getElementById('results').innerHTML = '';
        }

        // Close modal when clicking outside
        document.getElementById('imageModal').addEventListener('click', function (e) {
            if (e.target === this) {
                closeModal();
            }
        });

        // Touch navigation for mobile
        let touchStartX = 0;
        let touchEndX = 0;

        document.getElementById('imageModal').addEventListener('touchstart', function (e) {
            touchStartX = e.changedTouches[0].screenX;
        });

        document.getElementById('imageModal').addEventListener('touchend', function (e) {
            touchEndX = e.changedTouches[0].screenX;
            handleSwipe();
        });

        function handleSwipe() {
            const swipeThreshold = 50;
            const diff = touchStartX - touchEndX;

            if (Math.abs(diff) > swipeThreshold) {
                if (diff > 0) {
                    // Swipe left - show next photo
                    showNextPhoto();
                } else {
                    // Swipe right - show previous photo
                    showPreviousPhoto();
                }
            }
        }

        // Close modal with Escape key and navigate with arrow keys
        document.addEventListener('keydown', function (e) {
            if (e.key === 'Escape') {
                closeModal();
            } else if (document.getElementById('imageModal').style.display === 'flex') {
                if (e.key === 'ArrowLeft') {
                    showPreviousPhoto();
                } else if (e.key === 'ArrowRight') {
                    showNextPhoto();
                }
            }
        });

        // Download logic
        function isLikelyMobile() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        }
        function isIOS() {
            return /iP(hone|od|ad)/i.test(navigator.userAgent) ||
                (navigator.userAgent.includes('Mac') && 'ontouchend' in document);
        }

        async function downloadCurrentPhoto() {
            try {
                if (!currentModalPhoto || !currentModalPhoto.url) {
                    return;
                }

                const filename = currentModalPhoto.filename || 'photo.jpg';

                // iOS-specific handling: try to save directly to Photos app
                if (isIOS()) {
                    try {
                        // First, try to fetch the image as a blob
                        const response = await fetch(currentModalPhoto.url, { mode: 'cors', credentials: 'omit' });
                        if (!response.ok) throw new Error('Failed to fetch image');
                        const blob = await response.blob();
                        const file = new File([blob], filename, { type: blob.type || 'image/jpeg' });

                        // Try Web Share API with file for direct save to Photos
                        if (navigator.share && navigator.canShare) {
                            try {
                                await navigator.share({
                                    files: [file],
                                    title: `Sail ${currentModalPhoto.sail_number || ''} - Sailing Photo`,
                                    text: `Sailing photo from ${currentModalPhoto.location || 'regatta'}`
                                });
                                return;
                            } catch (e) {
                                console.log('Web Share with file failed, trying URL share');
                            }
                        }

                        // Fallback: try sharing URL with instructions
                        if (navigator.share) {
                            try {
                                await navigator.share({
                                    title: 'Save Sailing Photo to Camera Roll',
                                    text: `Tap and hold the image link to save to your camera roll: ${currentModalPhoto.url}`,
                                    url: currentModalPhoto.url
                                });
                                return;
                            } catch (e) {
                                console.log('Web Share API failed');
                            }
                        }

                        // Final fallback: open in new tab with instructions
                        const newWindow = window.open(currentModalPhoto.url, '_blank');
                        if (newWindow) {
                            // Show a brief instruction
                            setTimeout(() => {
                                alert('To save to your camera roll:\n1. Tap and hold the image\n2. Select "Add to Photos" or "Save to Photos"');
                            }, 500);
                        }
                        return;
                    } catch (err) {
                        console.error('iOS download error:', err);
                        // Ultimate fallback
                        window.open(currentModalPhoto.url, '_blank');
                        setTimeout(() => {
                            alert('To save to your camera roll:\n1. Tap and hold the image\n2. Select "Add to Photos"');
                        }, 500);
                        return;
                    }
                }

                // Non-iOS: try fetching and downloading as file
                const response = await fetch(currentModalPhoto.url, { mode: 'cors', credentials: 'omit' });
                if (!response.ok) throw new Error('Failed to fetch image');
                const blob = await response.blob();
                const fileType = blob.type || 'image/jpeg';

                // Prefer Web Share API with files on Android mobile to save to gallery
                if (isLikelyMobile() && navigator.share && navigator.canShare) {
                    const file = new File([blob], filename, { type: fileType });
                    if (navigator.canShare({ files: [file] })) {
                        try {
                            await navigator.share({ files: [file], title: 'Sailing Photo' });
                            return;
                        } catch (e) {
                            // fall through to local download
                        }
                    }
                }

                // Desktop and general fallback: trigger a local download
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            } catch (err) {
                console.error('Download error:', err);
                try { window.open(currentModalPhoto.url, '_blank'); } catch (e) { /* ignore */ }
            }
        }

        // Share photo link
        async function sharePhotoLink() {
            try {
                if (!currentModalPhoto || !currentModalPhoto.url) {
                    return;
                }

                const photoUrl = currentModalPhoto.url;
                const filename = currentModalPhoto.filename || 'sailing-photo';
                const sailNumber = currentModalPhoto.sail_number || 'Unknown';

                // Create share data
                const shareData = {
                    title: `Sailing Photo - Sail #${sailNumber}`,
                    text: `Check out this sailing photo from ${currentModalPhoto.location || 'our regatta'}`,
                    url: photoUrl
                };

                // Try Web Share API first (mobile)
                if (navigator.share && isLikelyMobile()) {
                    try {
                        await navigator.share(shareData);
                        return;
                    } catch (err) {
                        if (err.name !== 'AbortError') {
                            console.log('Web Share API failed, falling back to clipboard');
                        } else {
                            return; // User cancelled
                        }
                    }
                }

                // Fallback: copy to clipboard
                try {
                    await navigator.clipboard.writeText(photoUrl);

                    // Show success feedback by briefly changing opacity
                    const shareBtn = document.getElementById('shareBtn');
                    const originalOpacity = shareBtn.style.opacity;

                    shareBtn.style.opacity = '0.5';

                    setTimeout(() => {
                        shareBtn.style.opacity = originalOpacity || '1';
                    }, 300);

                } catch (clipboardErr) {
                    // Final fallback: show URL in alert
                    alert(`Photo URL:\n${photoUrl}\n\nCopy this link to share the photo.`);
                }

            } catch (err) {
                console.error('Share error:', err);
                alert('Unable to share photo link. Please try again.');
            }
        }


        // Navigation functions
        function showPreviousPhoto() {
            if (currentPhotoIndex > 0 && currentPhotosArray.length > 0) {
                const prevPhoto = currentPhotosArray[currentPhotoIndex - 1];
                openModal(prevPhoto, currentPhotoIndex - 1, currentPhotosArray);
            }
        }

        function showNextPhoto() {
            if (currentPhotoIndex < currentPhotosArray.length - 1 && currentPhotosArray.length > 0) {
                const nextPhoto = currentPhotosArray[currentPhotoIndex + 1];
                openModal(nextPhoto, currentPhotoIndex + 1, currentPhotosArray);
            }
        }
    </script>
</body>

</html>